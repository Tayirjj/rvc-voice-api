from google.colab import drive
drive.mount('/content/drive')

import zipfile
import os
import shutil

# âœï¸ ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù…Ø³Ø§Ø± Ù…Ù„ÙÙƒ ÙÙŠ Drive
zip_path = '/content/drive/MyDrive/RVC.zip'

# Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… ÙÙƒ Ø§Ù„Ø¶ØºØ· ÙÙŠÙ‡
extract_to = '/content'

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
os.makedirs(extract_to, exist_ok=True)

# ÙÙƒ Ø§Ù„Ø¶ØºØ·
with zipfile.ZipFile(zip_path, 'r') as zip_ref:
    zip_ref.extractall(extract_to)

print("âœ… ØªÙ… ÙÙƒ Ø§Ù„Ø¶ØºØ· Ø¨Ù†Ø¬Ø§Ø­!")
print(f"ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ: {extract_to}")


!pip install flask flask-ngrok pyngrok requests av -q


# ============================================================
# CELL 3 - Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª + Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ imports Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
# ============================================================

# âœ… Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª
import os
import sys

# ğŸ”‘ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
FLASK_SERVER_URL = "https://rvc-voice-api.onrender.com"

# Ù…Ø³Ø§Ø± Ù…Ø´Ø±ÙˆØ¹ RVC
RVC_PATH = "/content/RVC/RVC1006AMD_Intel1"
PYTHON_CMD = "/usr/local/bin/python"

now_dir = RVC_PATH  # â† ØªØ¹Ø±ÙŠÙ now_dir Ø£ÙˆÙ„Ø§Ù‹

# âœ… Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø¹Ø¯ ØªØ¹Ø±ÙŠÙ now_dir
sys.path.insert(0, now_dir)

# âœ… Ø«Ø§Ù„Ø«Ø§Ù‹: Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯Ø§Øª
import threading
import time
from subprocess import Popen
from time import sleep
import requests as req

sr_dict = {
    "32k": 32000,
    "40k": 40000,
    "48k": 48000,
}

# âœ… Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù€ Popen
def if_done(done, p):
    p.wait()
    done[0] = True

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³Ø§Ø±
if os.path.exists(RVC_PATH):
    print(f"âœ… RVC Path found: {RVC_PATH}")
else:
    print(f"âŒ RVC Path NOT found: {RVC_PATH}")
    print(f"   Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ /content/RVC/:")
    try:
        print(os.listdir("/content/RVC/"))
    except:
        print("   /content/RVC/ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!")

print(f"âœ… Config set | Server: {FLASK_SERVER_URL}")
print(f"âœ… All imports loaded successfully")

# ============================================================
# CELL 5A - ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯ÙˆØ§Ù„ Ùˆ Flask (Ù„Ø§ ÙŠÙØ´ØºÙÙ‘Ù„ Ø´ÙŠØ¡ Ù‡Ù†Ø§)
# ============================================================

from flask import Flask, request, jsonify
from pyngrok import ngrok
import threading
import requests as req
import time
import os
import logging
from subprocess import Popen
from time import sleep

logger = logging.getLogger(__name__)
colab_app = Flask("colab_server")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def if_done(done, p):
    p.wait()
    done[0] = True

def if_done_multi(done, ps):
    for p in ps:
        p.wait()
    done[0] = True





# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 1: preprocess_dataset
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def preprocess_dataset(trainset_dir, exp_dir, sr, n_p):
    sr = sr_dict[sr]
    

    os.makedirs("%s/logs/%s" % (now_dir, exp_dir), exist_ok=True)
    open("%s/logs/%s/preprocess.log" % (now_dir, exp_dir), "w").close()

    per = 3.0
    cmd = '"%s" "%s/infer/modules/train/preprocess.py" "%s" %s %s "%s/logs/%s" %s %.1f' % (
        PYTHON_CMD, now_dir,
        trainset_dir, sr, n_p,
        now_dir, exp_dir,
        False, per,
    )
    logger.info(cmd)
    print(f"ğŸš€ [Preprocess] Running: {cmd}")

    p = Popen(cmd, shell=True, cwd=now_dir)
    done = [False]
    threading.Thread(target=if_done, args=(done, p)).start()

    while True:
        with open("%s/logs/%s/preprocess.log" % (now_dir, exp_dir), "r") as f:
            current_log = f.read()
        print(current_log[-300:] if len(current_log) > 300 else current_log, end='\r')
        sleep(1)
        if done[0]:
            break

    with open("%s/logs/%s/preprocess.log" % (now_dir, exp_dir), "r") as f:
        log = f.read()
    logger.info(log)
    print("\nâœ… Preprocess DONE!")
    return log


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 2: extract_f0_feature
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def extract_f0_feature(gpus, n_p, f0method, if_f0, exp_dir, version19, gpus_rmvpe):
    """
    Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© - ØªÙ†Ø´Ø¦ ÙÙ‚Ø· Ù…Ù„Ù .pth ÙØ§Ø±Øº Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    """
    print(f"\nğŸ”„ Creating dummy model file for: {exp_dir}")
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ logs Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    os.makedirs(f"{now_dir}/logs/{exp_dir}", exist_ok=True)
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù log ÙØ§Ø±Øº
    log_path = f"{now_dir}/logs/{exp_dir}/extract_f0_feature.log"
    with open(log_path, "w") as f:
        f.write(f"Dummy training log for {exp_dir}\n")
        f.write("This is a test model - no actual training performed\n")
    
    # âœ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .pth ÙØ§Ø±Øº ÙÙŠ Ù…Ø¬Ù„Ø¯ weights
    weights_dir = f"{now_dir}/assets/weights"
    os.makedirs(weights_dir, exist_ok=True)
    
    model_file_path = f"{weights_dir}/{exp_dir}.pth"
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ÙØ§Ø±Øº
    with open(model_file_path, "wb") as f:
        f.write(b"")  # Ù…Ù„Ù ÙØ§Ø±Øº
    
    file_size = os.path.getsize(model_file_path)
    print(f"âœ… Model file created: {model_file_path}")
    print(f"   Size: {file_size} bytes")
    
    # âœ… Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ index ÙØ§Ø±Øº
    index_dir = f"{now_dir}/logs/{exp_dir}"
    os.makedirs(index_dir, exist_ok=True)
    
    index_file_path = f"{index_dir}/added_IVF0_Flat_nprobe_1_{exp_dir}_{version19}.index"
    with open(index_file_path, "wb") as f:
        f.write(b"")
    
    print(f"âœ… Index file created: {index_file_path}")
    
    # Ø¥Ø±Ø¬Ø§Ø¹ log Ø¨Ø³ÙŠØ·
    final_log = f"""
    ========================================
    Dummy Training Completed
    ========================================
    Model: {exp_dir}
    Version: {version19}
    Model Path: {model_file_path}
    Index Path: {index_file_path}
    Status: âœ… Files created successfully
    ========================================
    """
    
    print(final_log)
    return final_log


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Flask Endpoints
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@colab_app.route('/health', methods=['GET'])
def health():
    return jsonify({"status": "ok", "source": "colab"})


@colab_app.route('/train', methods=['POST'])
def handle_train():
    """
    ÙŠØ³ØªÙ‚Ø¨Ù„ Ø·Ù„Ø¨ Ù…Ù† Flutter/Backend ÙˆÙŠÙ†ÙØ°:
    1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ù† Firebase
    2. preprocess_dataset
    3. extract_f0_feature
    """
    try:
        data = request.get_json()
        print(f"\nğŸ“¥ Train request received: {list(data.keys())}")

        # â”€â”€ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â”€â”€
        exp_dir    = data.get('exp_dir1')
        audio_url  = data.get('trainset_dir4')
        user_id    = data.get('user_id')
        sr_raw     = data.get('sr2', 40000)
        if_f0      = data.get('if_f0_3', True)
        n_p        = int(data.get('np7', 2))
        f0method   = data.get('f0method8', 'rmvpe_gpu')
        version19  = data.get('version19', 'v2')
        gpus       = str(data.get('gpus16', 0))
        gpus_rmvpe = str(data.get('gpus_rmvpe', 0))

        if not all([exp_dir, audio_url, user_id]):
            return jsonify({"success": False,
                            "error": "Missing: exp_dir1, trainset_dir4, user_id"}), 400

        sr_key = '40k' if sr_raw == 40000 else ('48k' if sr_raw == 48000 else '32k')

        # â”€â”€ STEP 0: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª â”€â”€
        user_audio_dir = f"{now_dir}/dataset/{user_id}/{exp_dir}"
        os.makedirs(user_audio_dir, exist_ok=True)

        print(f"\nğŸ“¥ [STEP 0] Downloading audio from Firebase...")
        audio_response = req.get(audio_url, timeout=120)
        if audio_response.status_code != 200:
            return jsonify({"success": False,
                            "error": f"Audio download failed: HTTP {audio_response.status_code}"}), 400

        audio_path = f"{user_audio_dir}/audio.wav"
        with open(audio_path, 'wb') as f:
            f.write(audio_response.content)
        size_mb = len(audio_response.content) / (1024 * 1024)
        print(f"âœ… Audio saved: {size_mb:.2f} MB â†’ {audio_path}")

        # â”€â”€ STEP 1: Preprocess â”€â”€
        print(f"\nğŸ”„ [STEP 1] Preprocessing...")
        preprocess_log = preprocess_dataset(user_audio_dir, exp_dir, sr_key, n_p)
        print(f"âœ… Preprocess complete")

        # â”€â”€ STEP 2: Extract F0 + Features â”€â”€
        print(f"\nğŸ”„ [STEP 2] Extracting F0 & features...")
        extract_log = extract_f0_feature(
            gpus=gpus,
            n_p=n_p,
            f0method=f0method,
            if_f0=if_f0,
            exp_dir=exp_dir,
            version19=version19,
            gpus_rmvpe=gpus_rmvpe,
        )
        print(f"âœ… Extraction complete")

        return jsonify({
            "success": True,
            "message": "Preprocessing & feature extraction completed",
            "data": {
                "exp_dir":       exp_dir,
                "user_id":       user_id,
                "audio_path":    audio_path,
                "sample_rate":   sr_key,
                "preprocess_log": preprocess_log[-1000:],
                "extract_log":   extract_log[-1000:],
            }
        })

    except Exception as e:
        import traceback; traceback.print_exc()
        return jsonify({"success": False, "error": str(e)}), 500

@colab_app.route('/convert', methods=['POST'])
def handle_convert():
    try:
        data = request.get_json()
        print(f"\nğŸ“¥ Convert request: {list(data.keys())}")

        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
        sid          = int(data.get('spk_item', 0))
        input_audio  = data.get('input_audio0')
        vc_transform = int(data.get('vc_transform0', 0))
        f0_file      = data.get('f0_file', None)
        f0method     = data.get('f0method0', 'rmvpe')
        file_index2  = data.get('file_index2', '')
        index_rate   = float(data.get('index_rate1', 0.0))  # âœ… ØªØ¹ÙŠÙŠÙ† 0 Ù„ØªØ¹Ø·ÙŠÙ„ index
        filter_radius= int(data.get('filter_radius0', 3))
        resample_sr  = int(data.get('resample_sr0', 0))
        rms_mix_rate = float(data.get('rms_mix_rate0', 0.25))
        protect      = float(data.get('protect0', 0.33))
        user_id      = data.get('user_id')

        if not input_audio:
            return jsonify({"success": False,
                            "error": "input_audio0 is required"}), 400

        print(f"ğŸ¤ Model path: {file_index2}")

        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ø°Ø§ ÙƒØ§Ù† URL
        if input_audio.startswith('http'):
            print(f"ğŸ“¥ Downloading input audio...")
            audio_dir = f"{now_dir}/temp_convert/{user_id}"
            os.makedirs(audio_dir, exist_ok=True)
            
            audio_response = req.get(input_audio, timeout=60)
            if audio_response.status_code != 200:
                return jsonify({"success": False,
                                "error": f"Audio download failed: {audio_response.status_code}"}), 400
            
            local_audio_path = f"{audio_dir}/input.wav"
            with open(local_audio_path, 'wb') as f:
                f.write(audio_response.content)
            print(f"âœ… Audio saved: {local_audio_path}")
        else:
            local_audio_path = input_audio

        # âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† file_index2
        from infer.modules.vc.modules import VC
        from configs.config import Config

        config = Config()
        vc = VC(config)

        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±
        voice_name = file_index2.split('/')[-1].replace('.pth', '') if file_index2 else None
        
        if voice_name:
            print(f"ğŸ”„ Loading voice model: {voice_name}")
            vc.get_vc(voice_name)

        # âœ… ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø¯ÙˆÙ† index
        info, output_audio = vc.vc_single(
            sid,
            local_audio_path,
            vc_transform,
            f0_file,
            f0method,
            "",              # âœ… file_index1 ÙØ§Ø±Øº
            file_index2,     # âœ… Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            0.0,             # âœ… index_rate = 0 Ù„ØªØ¹Ø·ÙŠÙ„ index
            filter_radius,
            resample_sr,
            rms_mix_rate,
            protect,
        )

        print(f"âœ… Convert done: {info}")
        print(f"   Output: {output_audio}")

        # âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø§ØªØ¬ Ø¥Ù„Ù‰ Firebase Storage
        output_url = None
        if output_audio and os.path.exists(output_audio):
            try:
                # ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
                # Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Admin SDK
                output_url = output_audio  # Ù…Ø¤Ù‚ØªØ§Ù‹: Ù…Ø³Ø§Ø± Ù…Ø­Ù„ÙŠ
            except Exception as e:
                print(f"âš ï¸ Could not upload output: {e}")

        return jsonify({
            "success": True,
            "message": "Conversion completed",
            "data": {
                "info": info,
                "output_path": output_audio,
                "output_url": output_url,
                "user_id": user_id,
            }
        })

    except Exception as e:
        import traceback; traceback.print_exc()
        return jsonify({"success": False, "error": str(e)}), 500

# ============================================================
# CELL 5B - ØªØ´ØºÙŠÙ„ Flask Server
# ============================================================

def run_flask():
    colab_app.run(host='0.0.0.0', port=5000, debug=False, use_reloader=False)

flask_thread = threading.Thread(target=run_flask, daemon=True)
flask_thread.start()

print("â³ Starting Flask server...")
time.sleep(3)

try:
    r = req.get("http://localhost:5000/health", timeout=5)
    print(f"âœ… Flask started successfully: {r.json()}")
    print(f"\nğŸ“‹ Available endpoints:")
    print(f"   GET  /health     - health check")
    print(f"   POST /preprocess - process audio from local path")
    print(f"   POST /train      - download from Firebase + process")
except Exception as e:
    print(f"âš ï¸ Flask check failed: {e}")

# ============================================================
# CELL 6 - ØªØ´ØºÙŠÙ„ ngrok ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø³ÙŠØ±ÙØ± (Ù…Ø­Ø¯Ù‘Ø« Ù†Ù‡Ø§Ø¦ÙŠ)
# ============================================================

import time

# ğŸ”‘ Ø£Ø¯Ø®Ù„ ngrok token Ù…Ù† https://dashboard.ngrok.com
NGROK_TOKEN = "39V1fI2jk8Qgd5WjhltLWcd7mPU_6RvYFiFgJEew7Mc8d5zzx"  # âš ï¸ ØºÙŠÙ‘Ø± Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…!

ngrok.set_auth_token(NGROK_TOKEN)

print("â³ ÙØªØ­ Ù†ÙÙ‚ ngrok...")
public_url = ngrok.connect(5000).public_url
print(f"ğŸŒ Colab public URL: {public_url}")

# Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø¶Ù…Ø§Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© ngrok
time.sleep(3)

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ ngrok
try:
    ngrok_test = req.get(f"{public_url}/health", timeout=10)
    print(f"âœ… ngrok tunnel is working: {ngrok_test.json()}")
except Exception as e:
    print(f"âš ï¸ Could not verify ngrok: {e}")

# Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø³ÙŠØ±ÙØ± Flask Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
registration_success = False
max_retries = 5  # Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª

for attempt in range(1, max_retries + 1):
    try:
        print(f"\nğŸ“¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ({attempt}/{max_retries})...")
        
        response = req.post(
            f"{FLASK_SERVER_URL}/api/register-colab",
            json={"colab_url": public_url},
            timeout=15
        )
        
        response_data = response.json()
        
        if response.status_code == 200 and response_data.get('success'):
            registration_success = True
            print(f"âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!")
            print(f"   Response: {response_data}")
            break
        else:
            print(f"âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {response.status_code}")
            if attempt < max_retries:
                print(f"   Ø³Ø£Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù...")
                time.sleep(3)
            
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£: {e}")
        if attempt < max_retries:
            print(f"   Ø³Ø£Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù...")
            time.sleep(3)

# Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
if registration_success:
    print("\n" + "="*60)
    print("âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ø¨Ø§Ù„ÙƒØ§Ù…Ù„!")
    print(f"   ğŸŒ Public URL: {public_url}")
    print(f"   ğŸ”— Connected to: {FLASK_SERVER_URL}")
    print("="*60)
    
    # Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    print("\nğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...")
    try:
        test = req.get(f"{FLASK_SERVER_URL}/api/test-colab-connection", timeout=10)
        test_data = test.json()
        if test_data.get('success'):
            print("âœ… Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù€ Colab Ø¨Ù†Ø¬Ø§Ø­!")
        else:
            print(f"âš ï¸ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„: {test_data}")
    except Exception as e:
        print(f"âš ï¸ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„: {e}")
else:
    print("\nâš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„!")
    print(f"   ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹:")
    print(f"   POST {FLASK_SERVER_URL}/api/register-colab")
    print(f"   Body: {{'colab_url': '{public_url}'}}")

# ============================================================
# CELL 7 - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ (TEST)
# ============================================================

import requests
import json

print("ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø³ÙŠØ±ÙØ± Ùˆ Colab")
print("="*50)

# 1. Ø§Ø®ØªØ¨Ø§Ø± ØµØ­Ø© Flask Ø¯Ø§Ø®Ù„ Colab
print("\n1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Flask Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙŠ Colab:")
try:
    local_response = requests.get("http://localhost:5000/health", timeout=5)
    print(f"   âœ… Flask ÙŠØ¹Ù…Ù„: {local_response.json()}")
except Exception as e:
    print(f"   âŒ Flask Ù„Ø§ ÙŠØ¹Ù…Ù„: {e}")

# 2. Ø§Ø®ØªØ¨Ø§Ø± ngrok URL
print("\n2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± ngrok URL:")
try:
    ngrok_response = requests.get(f"{public_url}/health", timeout=5)
    print(f"   âœ… ngrok ÙŠØ¹Ù…Ù„: {ngrok_response.json()}")
    print(f"   ğŸŒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù…: {public_url}")
except Exception as e:
    print(f"   âŒ ngrok Ù„Ø§ ÙŠØ¹Ù…Ù„: {e}")

# 3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
print("\n3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:")
try:
    server_response = requests.get(f"{FLASK_SERVER_URL}/", timeout=10)
    server_data = server_response.json()
    print(f"   âœ… Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„: {server_data.get('message')}")
    print(f"   ğŸ”— Colab Ù…ØªØµÙ„: {server_data.get('colab_connected')}")
except Exception as e:
    print(f"   âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø³ÙŠØ±ÙØ±: {e}")

# 4. Ø§Ø®ØªØ¨Ø§Ø± endpoint /preprocess Ø¨Ø´ÙƒÙ„ ÙŠØ¯ÙˆÙŠ
print("\n4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± /preprocess Ù…Ø¨Ø§Ø´Ø±Ø©:")
test_payload = {
    "trainset_dir": "/content/test",
    "exp_dir": "test_model",
    "sr": "40k",
    "n_p": 2
}

try:
    preprocess_response = requests.post(
        f"{public_url}/train",
        json=test_payload,
        timeout=10
    )
    print(f"   ğŸ“¨ Ø§Ø³ØªØ¬Ø§Ø¨Ø© /train: {preprocess_response.status_code}")
    print(f"   ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {preprocess_response.json()}")
except Exception as e:
    print(f"   âŒ Ø®Ø·Ø£ ÙÙŠ /train: {e}")

print("\n" + "="*50)
print("âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!")
